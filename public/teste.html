<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Profissional - Foody Delivery</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #333;
            --light-text-color: #fff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            grid-template-rows: auto 1fr;
            height: 100vh;
            overflow: hidden;
        }

        header {
            grid-column: 1 / -1;
            background-color: var(--primary-color);
            color: var(--light-text-color);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        nav {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            padding: 1rem;
            overflow-y: auto;
        }

        nav ul {
            list-style-type: none;
        }

        nav ul li {
            margin-bottom: 1rem;
        }

        nav ul li a {
            color: var(--light-text-color);
            text-decoration: none;
            display: block;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        main {
            padding: 1rem;
            overflow-y: auto;
        }

        .orders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .order-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            transition: transform 0.3s ease;
        }

        .order-card:hover {
            transform: translateY(-5px);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .order-status {
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .status-open { background-color: #f1c40f; color: #000; }
        .status-accepted { background-color: #3498db; color: #fff; }
        .status-ready { background-color: #2ecc71; color: #fff; }
        .status-onGoing { background-color: #9b59b6; color: #fff; }
        .status-dispatched { background-color: #e67e22; color: #fff; }

        .sidebar {
            background-color: #fff;
            border-left: 1px solid #ddd;
            padding: 1rem;
            overflow-y: auto;
        }

        .metric-card {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .metric-title {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .courier-deliveries {
            background-color: #fff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .courier-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .action-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .action-button:hover {
            background-color: #2980b9;
        }

        #createOrderForm {
            display: none;
        }

        #createOrderForm input,
        #createOrderForm select,
        #createOrderForm textarea {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #createOrderForm label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        #courierTimeTracking {
            margin-top: 1rem;
        }

        .courier-time-item {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Foody Delivery PDV</div>
            <div>
                <button id="toggleFormButton" class="action-button" onclick="toggleCreateOrderForm()">Criar Novo Pedido</button>
                <button id="toggleCourierTimeButton" class="action-button" onclick="toggleCourierTimeTracking()">Tempo em Rota</button>
            </div>
        </header>
        <nav>
            <ul>
                <li><a href="#" onclick="showReadyOrders()">Pedidos Prontos</a></li>
                <li><a href="#" onclick="showPriorityOrders()">Pedidos Prioritários</a></li>
                <li><a href="#" onclick="resetCounters()">Zerar Contadores</a></li>
                <li><a href="relatorios.html" target="_blank">Relatórios</a></li>
            </ul>
        </nav>
        <main>
            <div id="orderList" class="orders-container"></div>
        </main>
        <aside class="sidebar">
            <div class="metric-card">
                <div class="metric-title">Resumo de Pedidos</div>
                <div class="metric-value" id="totalOrders">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Valor Total Hoje</div>
                <div class="metric-value" id="totalValue">R$ 0,00</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Tempo Médio de Preparo</div>
                <div class="metric-value" id="avgPrepTime">0 min</div>
            </div>
            <div id="courierDeliveries"></div>
            <div id="courierTimeTracking" style="display: none;"></div>
        </aside>
    </div>

    <div id="createOrderForm" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Criar Novo Pedido</h2>
            <form>
                <!-- Campos do formulário aqui -->
            </form>
        </div>
    </div>

    <div id="ongoingModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="ongoingContent"></div>
        </div>
    </div>

    <div id="readyOrdersModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="readyOrdersContent"></div>
        </div>
    </div>

    <div id="priorityOrdersModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="priorityOrdersContent"></div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E",
            authDomain: "cabana-8d55e.firebaseapp.com",
            databaseURL: "https://cabana-8d55e-default-rtdb.firebaseio.com",
            projectId: "cabana-8d55e",
            storageBucket: "cabana-8d55e.appspot.com",
            messagingSenderId: "706144237954",
            appId: "1:706144237954:web:345c10370972486afc779b",
            measurementId: "G-96Y337GYT8"
        };
        firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();
        const firebaseFunctionUrl = 'https://us-central1-cabana-8d55e.cloudfunctions.net/getFoodyOrders/proxy';
        const trackingUrl = 'https://us-central1-cabana-8d55e.cloudfunctions.net/getFoodyTracking/tracking';
        const authToken = '8d7c77946d534444a168bb7da794febf';
        const foodyApiUrl = 'https://app.foodydelivery.com/rest/1.2/orders/';

        // Variáveis globais
        let orderPrepTimes = {};
        let totalPrepTime = 0;
        let preparedOrders = 0;
        let totalOrdersCount = 0;
        let totalOrdersValue = 0;
        let yesterdayOrdersValue = 0;
        let paymentMethods = { money: 0, card: 0, online: 0 };
        let currentOrders = [];
        let allOrdersToday = [];
        let courierDeliveries = {};
        let cancelledOrders = 0;
        let lastOrderStatuses = {};
        let priorityOrders = [];
        let courierTimeTrackingStart = {};
        let courierActiveOrders = {};
        let courierLastRouteTime = {};

        // Funções principais
        async function fetchOrders() {
            try {
                const now = new Date();
                const startDate = formatDate(new Date(now.setHours(0, 0, 0, 0)));
                const endDate = formatDate(new Date());
                const response = await axios.get(firebaseFunctionUrl, {
                    headers: {
                        'Authorization': authToken,
                        'Content-Type': 'application/json;charset=UTF-8'
                    },
                    params: {
                        url: `${foodyApiUrl}?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`
                    }
                });
                console.log('Pedidos recebidos:', response.data);
                allOrdersToday = response.data.filter(order => {
                    const orderDate = new Date(order.creationDate);
                    return isWithinTimeRange(orderDate);
                });
                currentOrders = allOrdersToday.filter(order =>
                    ['open', 'accepted', 'ready', 'onGoing', 'dispatched'].includes(order.status)
                );
                priorityOrders = currentOrders.filter(order => order.status === 'accepted');
                updateOrderList(currentOrders);
                updateDashboard(allOrdersToday);
                updatePrepTimes(currentOrders);
                updateCourierDeliveries(allOrdersToday);
                updateCourierStatus(allOrdersToday);
                saveDataToLocalStorage();
            } catch (error) {
                console.error('Erro ao buscar pedidos:', error);
                document.getElementById('orderList').innerHTML = '<p class="error">Erro ao carregar pedidos. Por favor, tente novamente mais tarde.</p>';
            }
        }

function updateOrderList(orders) {
    const orderList = document.getElementById('orderList');
    orderList.innerHTML = '';
    orders.forEach(order => {
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card';
        orderCard.innerHTML = `
            <div class="order-header">
                <h3>Pedido #${order.id}</h3>
                <span class="order-status status-${order.status.toLowerCase()}">${getStatusDisplay(order.status)}</span>
            </div>
            <p>Cliente: ${order.customer.customerName}</p>
            <p>Total: R$ ${order.orderTotal ? order.orderTotal.toFixed(2) : 'N/A'}</p>
            <p>Tempo de Preparo: <span id="prepTime-${order.id}">0 min</span></p>
            ${order.courier ? `<p>Motoboy: <span class="courier-name">${order.courier.courierName}</span></p>` : ''}
            <p>Método de Pagamento: ${translatePaymentMethod(order.paymentMethod)}</p>
            ${order.notes ? `<p>Observações: ${order.notes}</p>` : ''}
        `;
        orderList.appendChild(orderCard);
    });
}

function getStatusDisplay(status) {
    switch (status) {
        case 'open': return 'Aberto';
        case 'accepted': return 'Aceito';
        case 'ready': return 'Pronto';
        case 'onGoing': return 'A Caminho';
        case 'dispatched': return 'Despachado';
        case 'cancelled': return 'Cancelado';
        default: return status;
    }
}

function translatePaymentMethod(method) {
    switch (method) {
        case 'money': return 'Dinheiro';
        case 'card': return 'Cartão';
        case 'online': return 'Online';
        default: return method;
    }
}

function updateDashboard(allOrders) {
    totalOrdersCount = allOrders.length;
    totalOrdersValue = 0;
    paymentMethods = { money: 0, card: 0, online: 0 };
    cancelledOrders = allOrders.filter(order => order.status === 'cancelled').length;
    priorityOrders = allOrders.filter(order => order.status === 'accepted');

    allOrders.forEach(order => {
        if (order.status !== 'cancelled') {
            totalOrdersValue += order.orderTotal || 0;
            const paymentType = order.paymentMethod;
            paymentMethods[paymentType] = (paymentMethods[paymentType] || 0) + (order.orderTotal || 0);
        }
    });

    document.getElementById('totalOrders').textContent = totalOrdersCount;
    document.getElementById('totalValue').textContent = `R$ ${totalOrdersValue.toFixed(2)}`;

    const avgPrepTime = preparedOrders > 0 ? totalPrepTime / preparedOrders : 0;
    document.getElementById('avgPrepTime').textContent = `${avgPrepTime.toFixed(1)} min`;

    saveDataToLocalStorage();
}

function updatePrepTimes(orders) {
    const now = new Date();
    orders.forEach(order => {
        if (order.status === 'open' && !orderPrepTimes[order.id]) {
            orderPrepTimes[order.id] = now.getTime();
        } else if (order.status === 'onGoing' && orderPrepTimes[order.id]) {
            const prepTime = (now.getTime() - orderPrepTimes[order.id]) / 60000; // em minutos
            totalPrepTime += prepTime;
            preparedOrders++;
            delete orderPrepTimes[order.id];
        }
        const prepTimeElement = document.getElementById(`prepTime-${order.id}`);
        if (prepTimeElement) {
            prepTimeElement.textContent = `${getPrepTimeForOrder(order.id)} min`;
        }
    });
    saveDataToLocalStorage();
}

function getPrepTimeForOrder(orderId) {
    if (orderPrepTimes[orderId]) {
        const now = new Date();
        return ((now.getTime() - orderPrepTimes[orderId]) / 60000).toFixed(1);
    }
    return '0.0';
}

function updateCourierDeliveries(allOrders) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    courierDeliveries = {};

    allOrders.forEach(order => {
        if (order.courier && new Date(order.creationDate) >= today) {
            const courierName = order.courier.courierName;
            if (order.status === 'closed' || order.status === 'delivered') {
                courierDeliveries[courierName] = (courierDeliveries[courierName] || 0) + 1;
            }
        }
    });

    const courierDeliveriesElement = document.getElementById('courierDeliveries');
    courierDeliveriesElement.innerHTML = '<h3>Entregas por Motoboy (Hoje)</h3>';
    for (const [courierName, deliveries] of Object.entries(courierDeliveries)) {
        courierDeliveriesElement.innerHTML += `
            <div class="courier-deliveries">
                <span class="courier-name">${courierName}</span>: 
                <strong>${deliveries}</strong> entrega${deliveries !== 1 ? 's' : ''}
            </div>
        `;
    }
    saveDataToLocalStorage();
}

function updateCourierStatus(orders) {
    for (const courierName in courierActiveOrders) {
        courierActiveOrders[courierName] = [];
    }

    for (const order of orders) {
        if (order.courier) {
            const courierName = order.courier.courierName;
            if (!courierActiveOrders[courierName]) {
                courierActiveOrders[courierName] = [];
            }
            courierActiveOrders[courierName].push(order);
        }
    }

    for (const courierName in courierActiveOrders) {
        const activeOrders = courierActiveOrders[courierName];
        const allOnGoing = activeOrders.length > 0 && activeOrders.every(o => o.status === 'onGoing');
        const anyOnGoing = activeOrders.some(o => o.status === 'onGoing');

        if (allOnGoing && !courierTimeTrackingStart[courierName]) {
            courierTimeTrackingStart[courierName] = Date.now();
        } else if (!anyOnGoing && courierTimeTrackingStart[courierName]) {
            const elapsedTime = Math.floor((Date.now() - courierTimeTrackingStart[courierName]) / 1000);
            courierLastRouteTime[courierName] = new Date(elapsedTime * 1000).toISOString().substr(11, 8);
            delete courierTimeTrackingStart[courierName];
        }

        if (activeOrders.length === 0) {
            delete courierActiveOrders[courierName];
            delete courierTimeTrackingStart[courierName];
            delete courierLastRouteTime[courierName];
        }
    }

    updateCourierTimeTracking();
}

function updateCourierTimeTracking() {
    const trackingDiv = document.getElementById('courierTimeTracking');
    let content = '<h3>Tempo em Rota dos Motoboys</h3>';

    for (const courierName in courierActiveOrders) {
        const activeOrders = courierActiveOrders[courierName];
        const onGoingOrders = activeOrders.filter(o => o.status === 'onGoing');
        const startTime = courierTimeTrackingStart[courierName];
        
        let timeInRoute = '00:00:00';

        if (onGoingOrders.length > 0) {
            if (!startTime) {
                courierTimeTrackingStart[courierName] = Date.now();
            }
            const elapsedTime = Math.floor((Date.now() - courierTimeTrackingStart[courierName]) / 1000);
            timeInRoute = new Date(elapsedTime * 1000).toISOString().substr(11, 8);
        } else if (startTime) {
            delete courierTimeTrackingStart[courierName];
        }

        content += `
            <div class="courier-time-item">
                <span class="courier-name">${courierName}</span>: 
                <strong>${timeInRoute}</strong>
            </div>
        `;
    }

    trackingDiv.innerHTML = content;
}

function toggleCreateOrderForm() {
    const form = document.getElementById('createOrderForm');
    const button = document.getElementById('toggleFormButton');
    if (form.style.display === 'none') {
        form.style.display = 'block';
        button.textContent = 'Fechar Formulário';
    } else {
        form.style.display = 'none';
        button.textContent = 'Criar Novo Pedido';
    }
}

function toggleCourierTimeTracking() {
    const trackingDiv = document.getElementById('courierTimeTracking');
    const button = document.getElementById('toggleCourierTimeButton');
    if (trackingDiv.style.display === 'none') {
        trackingDiv.style.display = 'block';
        button.textContent = 'Ocultar Tempo em Rota';
        updateCourierTimeTracking();
    } else {
        trackingDiv.style.display = 'none';
        button.textContent = 'Tempo em Rota';
    }
}

function saveDataToLocalStorage() {
    localStorage.setItem('orderPrepTimes', JSON.stringify(orderPrepTimes));
    localStorage.setItem('totalPrepTime', totalPrepTime.toString());
    localStorage.setItem('preparedOrders', preparedOrders.toString());
    localStorage.setItem('totalOrdersCount', totalOrdersCount.toString());
    localStorage.setItem('totalOrdersValue', totalOrdersValue.toString());
    localStorage.setItem('yesterdayOrdersValue', yesterdayOrdersValue.toString());
    localStorage.setItem('paymentMethods', JSON.stringify(paymentMethods));
    localStorage.setItem('courierDeliveries', JSON.stringify(courierDeliveries));
    localStorage.setItem('cancelledOrders', cancelledOrders.toString());
    localStorage.setItem('priorityOrders', JSON.stringify(priorityOrders));
}

function loadDataFromLocalStorage() {
    const storedOrderPrepTimes = localStorage.getItem('orderPrepTimes');
    if (storedOrderPrepTimes) orderPrepTimes = JSON.parse(storedOrderPrepTimes);
    const storedTotalPrepTime = localStorage.getItem('totalPrepTime');
    if (storedTotalPrepTime) totalPrepTime = parseFloat(storedTotalPrepTime);
    const storedPreparedOrders = localStorage.getItem('preparedOrders');
    if (storedPreparedOrders) preparedOrders = parseInt(storedPreparedOrders);
    const storedTotalOrdersCount = localStorage.getItem('totalOrdersCount');
    if (storedTotalOrdersCount) totalOrdersCount = parseInt(storedTotalOrdersCount);
    const storedTotalOrdersValue = localStorage.getItem('totalOrdersValue');
    if (storedTotalOrdersValue) totalOrdersValue = parseFloat(storedTotalOrdersValue);
    const storedYesterdayOrdersValue = localStorage.getItem('yesterdayOrdersValue');
    if (storedYesterdayOrdersValue) yesterdayOrdersValue = parseFloat(storedYesterdayOrdersValue);
    const storedPaymentMethods = localStorage.getItem('paymentMethods');
    if (storedPaymentMethods) paymentMethods = JSON.parse(storedPaymentMethods);
    const storedCourierDeliveries = localStorage.getItem('courierDeliveries');
    if (storedCourierDeliveries) courierDeliveries = JSON.parse(storedCourierDeliveries);
    const storedCancelledOrders = localStorage.getItem('cancelledOrders');
    if (storedCancelledOrders) cancelledOrders = parseInt(storedCancelledOrders);
    const storedPriorityOrders = localStorage.getItem('priorityOrders');
    if (storedPriorityOrders) priorityOrders = JSON.parse(storedPriorityOrders);
}

// Inicialização
loadDataFromLocalStorage();
fetchOrders();
setInterval(fetchOrders, 30000); // Atualiza a cada 30 segundos
setInterval(updateCourierTimeTracking, 1000); // Atualiza o tempo em rota a cada segundo

// Event Listeners
document.querySelectorAll('.close').forEach(closeButton => {
    closeButton.onclick = function() {
        this.closest('.modal').style.display = 'none';
    }
});

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
    </script>
</body>
</html>
</antArtifact>
