<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Pedidos - Foody Delivery</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background-color: #343a40;
            color: #fff;
            padding: 10px 20px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        .container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        .column {
            flex: 1;
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 80vh;
            overflow-y: auto;
        }

        .column h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #495057;
            text-align: center;
        }

        .order-item {
            background-color: #ffffff;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }

        .order-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .order-id {
            font-weight: bold;
            color: #495057;
        }

        .order-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: #fff;
        }

        .status-aguardando {
            background-color: #ffc107;
        }

        .status-em-preparo {
            background-color: #17a2b8;
        }

        .status-em-entrega {
            background-color: #28a745;
        }

        .order-body {
            font-size: 14px;
            color: #495057;
        }

        .order-body p {
            margin: 5px 0;
        }

        .order-options {
            margin-top: 10px;
            text-align: right;
        }

        .order-options i {
            margin-left: 10px;
            cursor: pointer;
            color: #007bff;
            transition: color 0.3s ease;
        }

        .order-options i:hover {
            color: #0056b3;
        }

        .action-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .action-button:hover {
            background-color: #0056b3;
        }

        .footer {
            background-color: #343a40;
            color: #fff;
            text-align: center;
            padding: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Pedidos</h2>
            <div id="orderList" class="order-list"></div>
            <button id="resetButton" class="action-button" onclick="resetCounters()">Zerar Contadores</button>
            <button id="reportsButton" class="action-button" onclick="window.open('relatorios.html', '_blank')">Relatórios</button>
        </div>
        <div class="main-content">
            <div id="createOrderSection">
                <button id="toggleFormButton" onclick="toggleCreateOrderForm()">Criar Novo Pedido</button>
                <button id="toggleCourierTimeButton" onclick="toggleCourierTimeTracking()">Tempo em Rota dos Motoboys</button>
                <form id="createOrderForm" style="display: none;">
                    <label for="orderId">ID do Pedido:</label>
                    <input type="text" id="orderId" required>

                    <label for="customerName">Nome do Cliente:</label>
                    <input type="text" id="customerName" required>

                    <label for="customerPhone">Telefone do Cliente:</label>
                    <input type="text" id="customerPhone" required>

                    <label for="street">Logradouro:</label>
                    <input type="text" id="street" required>

                    <label for="streetNumber">Número:</label>
                    <input type="text" id="streetNumber" required>

                    <label for="neighborhood">Bairro:</label>
                    <input type="text" id="neighborhood" required>

                    <label for="complement">Complemento:</label>
                    <input type="text" id="complement">

                    <label for="zipCode">CEP:</label>
                    <input type="text" id="zipCode" required>

                    <label for="status">Status:</label>
                    <select id="status" required>
                        <option value="open">Aberto</option>
                        <option value="ready">Pronto</option>
                    </select>

                    <label for="orderDetails">Detalhes do Pedido:</label>
                    <textarea id="orderDetails" required></textarea>

                    <label>Método de Pagamento:</label>
                    <div>
                        <input type="radio" id="paymentMoney" name="paymentMethod" value="money" required>
                        <label for="paymentMoney">Dinheiro</label>
                        <input type="radio" id="paymentCard" name="paymentMethod" value="card">
                        <label for="paymentCard">Cartão</label>
                        <input type="radio" id="paymentOnline" name="paymentMethod" value="online">
                        <label for="paymentOnline">Online</label>
                    </div>

                    <label for="orderTotal">Valor Total:</label>
                    <input type="number" id="orderTotal" step="0.01" required>

                    <label for="notes">Observações:</label>
                    <textarea id="notes"></textarea>

                    <button type="button" onclick="submitOrder()" class="action-button">Criar Pedido</button>
                </form>
                <div id="courierTimeTracking" style="display: none;">
                    <!-- O conteúdo será preenchido dinamicamente pelo JavaScript -->
                </div>
            </div>

        <div class="dashboard">
            <div class="metric-card">
                <div class="metric-title">Resumo de Pedidos</div>
                <div><span class="label">Total:</span> <span id="totalOrders" class="metric-value">0</span></div>
                <div><span class="label">Em Andamento:</span> <span id="ongoingOrders" class="metric-value">0</span></div>
                <div><span class="label">Tempo Médio de Preparo:</span> <span id="avgPrepTime" class="metric-value">0 min</span></div>
                <div><span class="label">Pedidos em loja:</span> <span id="readyOrders" class="metric-value">0</span> <button class="view-button" onclick="showReadyOrders()">Ver</button></div>
                <div><span class="label">Cancelados:</span> <span id="cancelledOrders" class="metric-value">0</span></div>
                <div><span class="label">Prioridades:</span> <span id="priorityOrders" class="metric-value">0</span> <button class="view-button" onclick="showPriorityOrders()">Ver</button> <button class="print-button" onclick="printPriorityOrders()">Imprimir</button></div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Valor Total</div>
                <div><span class="label">Hoje:</span> <span id="totalValue" class="metric-value">R$ 0,00</span></div>
                <div><span class="label">Ontem:</span> <span id="yesterdayValue" class="metric-value">R$ 0,00</span></div>
                <div><span class="label">Ticket Médio:</span> <span id="averageTicket" class="metric-value">R$ 0,00</span></div>
                <div id="paymentBreakdown"></div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Entregas por Motoboy (Hoje)</div>
                <div id="courierDeliveries"></div>
            </div>
        </div>
    </div>
</div>
<div id="ongoingModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="ongoingContent"></div>
    </div>
</div>
<div id="readyOrdersModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="readyOrdersContent"></div>
    </div>
</div>
<div id="priorityOrdersModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="priorityOrdersContent"></div>
    </div>
</div>
<div id="cancellationPopup" class="cancellation-popup">
    <span class="close" onclick="closeCancellationPopup()">&times;</span>
    <p id="cancellationMessage"></p>
    <button class="hide-notification-button" onclick="hideCancellationNotification()">Ocultar notificação</button>
</div>
<div id="sameAddressPopup" class="same-address-popup">
    <span class="close" onclick="closeSameAddressPopup()">&times;</span>
    <p id="sameAddressMessage"></p>
    <button class="hide-notification-button" onclick="hideSameAddressNotification()">Ocultar notificação</button>
</div>
<script>
    // Configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E",
        authDomain: "cabana-8d55e.firebaseapp.com",
        databaseURL: "https://cabana-8d55e-default-rtdb.firebaseio.com",
        projectId: "cabana-8d55e",
        storageBucket: "cabana-8d55e.appspot.com",
        messagingSenderId: "706144237954",
        appId: "1:706144237954:web:345c10370972486afc779b",
        measurementId: "G-96Y337GYT8"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const firebaseFunctionUrl = 'https://us-central1-cabana-8d55e.cloudfunctions.net/getFoodyOrders/proxy';
    const trackingUrl = 'https://us-central1-cabana-8d55e.cloudfunctions.net/getFoodyTracking/tracking';
    const authToken = '8d7c77946d534444a168bb7da794febf';
    const foodyApiUrl = 'https://app.foodydelivery.com/rest/1.2/orders/';

    let orderPrepTimes = {};
    let totalPrepTime = 0;
    let preparedOrders = 0;
    let totalOrdersCount = 0;
    let totalOrdersValue = 0;
    let yesterdayOrdersValue = 0;
    let paymentMethods = {
        money: 0,
        card: 0,
        online: 0
    };
    let currentOrders = [];
    let allOrdersToday = [];
    let courierDeliveries = {};
    let cancelledOrders = 0;
    let lastOrderStatuses = {};
    let priorityOrders = [];
    let sameAddressOrders = {};
    let shownSameAddressNotifications = new Set();
    let lastShownNotificationTime = 0;
    let hiddenNotifications = {
        cancellation: false,
        sameAddress: false
    };

    // Novas variáveis para rastreamento de tempo em rota
    let courierTimeTrackingStart = {};
    let courierActiveOrders = {};
    let courierLastRouteTime = {};

    function saveDataToLocalStorage() {
        localStorage.setItem('orderPrepTimes', JSON.stringify(orderPrepTimes));
        localStorage.setItem('totalPrepTime', totalPrepTime.toString());
        localStorage.setItem('preparedOrders', preparedOrders.toString());
        localStorage.setItem('totalOrdersCount', totalOrdersCount.toString());
        localStorage.setItem('totalOrdersValue', totalOrdersValue.toString());
        localStorage.setItem('yesterdayOrdersValue', yesterdayOrdersValue.toString());
        localStorage.setItem('paymentMethods', JSON.stringify(paymentMethods));
        localStorage.setItem('courierDeliveries', JSON.stringify(courierDeliveries));
        localStorage.setItem('cancelledOrders', cancelledOrders.toString());
        localStorage.setItem('priorityOrders', JSON.stringify(priorityOrders));
        localStorage.setItem('sameAddressOrders', JSON.stringify(sameAddressOrders));
        localStorage.setItem('shownSameAddressNotifications', JSON.stringify(Array.from(shownSameAddressNotifications)));
        localStorage.setItem('lastShownNotificationTime', lastShownNotificationTime.toString());
        localStorage.setItem('hiddenNotifications', JSON.stringify(hiddenNotifications));
    }

    function loadDataFromLocalStorage() {
        const storedOrderPrepTimes = localStorage.getItem('orderPrepTimes');
        if (storedOrderPrepTimes) orderPrepTimes = JSON.parse(storedOrderPrepTimes);
        const storedTotalPrepTime = localStorage.getItem('totalPrepTime');
        if (storedTotalPrepTime) totalPrepTime = parseFloat(storedTotalPrepTime);
        const storedPreparedOrders = localStorage.getItem('preparedOrders');
        if (storedPreparedOrders) preparedOrders = parseInt(storedPreparedOrders);
        const storedTotalOrdersCount = localStorage.getItem('totalOrdersCount');
        if (storedTotalOrdersCount) totalOrdersCount = parseInt(storedTotalOrdersCount);
        const storedTotalOrdersValue = localStorage.getItem('totalOrdersValue');
        if (storedTotalOrdersValue) totalOrdersValue = parseFloat(storedTotalOrdersValue);
        const storedYesterdayOrdersValue = localStorage.getItem('yesterdayOrdersValue');
        if (storedYesterdayOrdersValue) yesterdayOrdersValue = parseFloat(storedYesterdayOrdersValue);
        const storedPaymentMethods = localStorage.getItem('paymentMethods');
        if (storedPaymentMethods) paymentMethods = JSON.parse(storedPaymentMethods);
        const storedCourierDeliveries = localStorage.getItem('courierDeliveries');
        if (storedCourierDeliveries) courierDeliveries = JSON.parse(storedCourierDeliveries);
        const storedCancelledOrders = localStorage.getItem('cancelledOrders');
        if (storedCancelledOrders) cancelledOrders = parseInt(storedCancelledOrders);
        const storedPriorityOrders = localStorage.getItem('priorityOrders');
        if (storedPriorityOrders) priorityOrders = JSON.parse(storedPriorityOrders);
        const storedSameAddressOrders = localStorage.getItem('sameAddressOrders');
        if (storedSameAddressOrders) sameAddressOrders = JSON.parse(storedSameAddressOrders);
        const storedShownSameAddressNotifications = localStorage.getItem('shownSameAddressNotifications');
        if (storedShownSameAddressNotifications) shownSameAddressNotifications = new Set(JSON.parse(storedShownSameAddressNotifications));
        const storedLastShownNotificationTime = localStorage.getItem('lastShownNotificationTime');
        if (storedLastShownNotificationTime) lastShownNotificationTime = parseInt(storedLastShownNotificationTime);
        const storedHiddenNotifications = localStorage.getItem('hiddenNotifications');
        if (storedHiddenNotifications) hiddenNotifications = JSON.parse(storedHiddenNotifications);
    }

    async function fetchOrders() {
        try {
            const now = new Date();
            const startDate = formatDate(new Date(now.setHours(0, 0, 0, 0)));
            const endDate = formatDate(new Date());
            const response = await axios.get(firebaseFunctionUrl, {
                headers: {
                    'Authorization': authToken,
                    'Content-Type': 'application/json;charset=UTF-8'
                },
                params: {
                    url: `${foodyApiUrl}?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`
                }
            });
            console.log('Pedidos recebidos:', response.data);
            allOrdersToday = response.data.filter(order => {
                const orderDate = new Date(order.creationDate);
                return isWithinTimeRange(orderDate);
            });
            const filteredOrders = allOrdersToday.filter(order =>
                ['open', 'accepted', 'ready', 'onGoing', 'dispatched'].includes(order.status)
            );
            currentOrders = filteredOrders;
            priorityOrders = currentOrders.filter(order => order.status === 'accepted');
            updateOrderList(currentOrders);
            updateDashboard(allOrdersToday);
            updatePrepTimes(currentOrders);
            updateCourierDeliveries(allOrdersToday);
            checkForCancelledOrders(allOrdersToday);
            checkForSameAddressOrders(allOrdersToday);
            updateCourierStatus(allOrdersToday);
            fetchYesterdayOrders();
            saveDataToLocalStorage();
        } catch (error) {
            console.error('Erro ao buscar pedidos:', error);
            document.getElementById('orderList').innerHTML = '<p class="error">Erro ao carregar pedidos. Por favor, tente novamente mais tarde.</p>';
        }
    }

    async function fetchYesterdayOrders() {
        try {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const startDate = formatDate(new Date(yesterday.setHours(0, 0, 0, 0)));
            const endDate = formatDate(new Date(yesterday.setHours(23, 59, 59, 999)));
            const response = await axios.get(firebaseFunctionUrl, {
                headers: {
                    'Authorization': authToken,
                    'Content-Type': 'application/json;charset=UTF-8'
                },
                params: {
                    url: `${foodyApiUrl}?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`
                }
            });
            const yesterdayOrders = response.data.filter(order => isWithinTimeRange(new Date(order.creationDate)));
            yesterdayOrdersValue = yesterdayOrders.reduce((total, order) => total + (order.orderTotal || 0), 0);
            document.getElementById('yesterdayValue').textContent = `R$ ${yesterdayOrdersValue.toFixed(2)}`;
            saveDataToLocalStorage();
        } catch (error) {
            console.error('Erro ao buscar pedidos de ontem:', error);
        }
    }

    function updateOrderList(orders) {
        const orderList = document.getElementById('orderList');
        orderList.innerHTML = '';
        orders.forEach(order => {
            const orderDiv = document.createElement('div');
            orderDiv.className = 'order-item';
            orderDiv.innerHTML = `
                <h3>Pedido #${order.id}</h3>
                <p class="status-${order.status.toLowerCase()}">${getStatusDisplay(order.status)}</p>
                <p>Cliente: ${order.customer.customerName}</p>
                ${order.courier ? `<p>Motoboy: <span class="courier-name">${order.courier.courierName}</span></p>` : ''}
<p>Método de Pagamento: ${translatePaymentMethod(order.paymentMethod)}</p>
<p>Total do Pedido: R$ ${order.orderTotal ? order.orderTotal.toFixed(2) : 'N/A'}</p>
${order.notes ? `<p>Observações: ${order.notes}</p>` : ''}
<p>Tempo de Preparo: <span id="prepTime-${order.id}">0 min</span></p>
<div class="order-options">
<i class="fas fa-map-marker-alt"></i>
</div>
`;
orderList.appendChild(orderDiv);
});
}

    function formatDate(date) {
        return date.toISOString().replace(/\.\d{3}Z$/, '-03:00');
    }

    function isWithinTimeRange(date) {
        const hour = date.getHours();
        const minutes = date.getMinutes();
        const totalMinutes = hour * 60 + minutes;
        return totalMinutes >= 12 * 60 + 30 && totalMinutes <= 22 * 60 + 30;
    }

    function getStatusDisplay(status) {
        switch (status) {
            case 'open': return 'Aberto';
            case 'accepted': return 'Aceito';
            case 'ready': return 'Pronto';
            case 'onGoing': return 'A Caminho';
            case 'dispatched': return 'Despachado';
            case 'cancelled': return 'Cancelado';
            default: return status;
        }
    }

    function translatePaymentMethod(method) {
        switch (method) {
            case 'money': return 'Dinheiro';
            case 'card': return 'Cartão';
            case 'online': return 'Online';
            default: return method;
        }
    }

    function updateDashboard(allOrders) {
        totalOrdersCount = allOrders.length;
        totalOrdersValue = 0;
        paymentMethods = {
            money: 0,
            card: 0,
            online: 0
        };
        cancelledOrders = allOrders.filter(order => order.status === 'cancelled').length;
        priorityOrders = allOrders.filter(order => order.status === 'accepted');
        allOrders.forEach(order => {
            if (order.status !== 'cancelled') {
                totalOrdersValue += order.orderTotal || 0;
                const paymentType = order.paymentMethod;
                paymentMethods[paymentType] = (paymentMethods[paymentType] || 0) + (order.orderTotal || 0);
            }
        });
        document.getElementById('totalOrders').textContent = totalOrdersCount;
        document.getElementById('ongoingOrders').textContent = currentOrders.filter(order => order.status === 'onGoing').length;
        document.getElementById('readyOrders').textContent = currentOrders.filter(order => order.status === 'ready').length;
        document.getElementById('cancelledOrders').textContent = cancelledOrders;
        document.getElementById('priorityOrders').textContent = priorityOrders.length;
        document.getElementById('totalValue').textContent = `R$ ${totalOrdersValue.toFixed(2)}`;
        const completedOrders = allOrders.filter(order => order.status !== 'cancelled');
        const averageTicket = completedOrders.length > 0 ? totalOrdersValue / completedOrders.length : 0;
        document.getElementById('averageTicket').textContent = `R$ ${averageTicket.toFixed(2)}`;
        const paymentBreakdown = document.getElementById('paymentBreakdown');
        paymentBreakdown.innerHTML = '';
        for (const [method, value] of Object.entries(paymentMethods)) {
            paymentBreakdown.innerHTML += `<p>${translatePaymentMethod(method)}: R$ ${value.toFixed(2)}</p>`;
        }
        saveDataToLocalStorage();
    }

    function updatePrepTimes(orders) {
        const now = new Date();
        orders.forEach(order => {
            if (order.status === 'open' && !orderPrepTimes[order.id]) {
                orderPrepTimes[order.id] = now.getTime();
            } else if (order.status === 'onGoing' && orderPrepTimes[order.id]) {
                const prepTime = (now.getTime() - orderPrepTimes[order.id]) / 60000; // em minutos
                totalPrepTime += prepTime;
                preparedOrders++;
                delete orderPrepTimes[order.id];
            }
            const prepTimeElement = document.getElementById(`prepTime-${order.id}`);
            if (prepTimeElement) {
                prepTimeElement.textContent = `${getPrepTimeForOrder(order.id)} min`;
            }
        });
        const avgPrepTime = preparedOrders > 0 ? totalPrepTime / preparedOrders : 0;
        document.getElementById('avgPrepTime').textContent = `${avgPrepTime.toFixed(1)} min`;
        saveDataToLocalStorage();
    }

    function getPrepTimeForOrder(orderId) {
        if (orderPrepTimes[orderId]) {
            const now = new Date();
            return ((now.getTime() - orderPrepTimes[orderId]) / 60000).toFixed(1);
        }
        return '0.0';
    }

    function updateCourierDeliveries(allOrders) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        courierDeliveries = {};
        const ongoingDeliveries = {};
        sameAddressOrders = {};
        allOrders.forEach(order => {
            if (order.courier && new Date(order.creationDate) >= today) {
                const courierName = order.courier.courierName;
                if (order.status === 'closed' || order.status === 'delivered') {
                    courierDeliveries[courierName] = (courierDeliveries[courierName] || 0) + 1;
                } else if (['accepted', 'ready', 'onGoing', 'dispatched'].includes(order.status)) {
                    if (!ongoingDeliveries[courierName]) {
                        ongoingDeliveries[courierName] = [];
                    }
                    ongoingDeliveries[courierName].push(order);
                    // Check for same address deliveries
                    const address = `${order.deliveryPoint.street} ${order.deliveryPoint.houseNumber}`;
                    if (!sameAddressOrders[courierName]) {
                        sameAddressOrders[courierName] = {};
                    }
                    if (!sameAddressOrders[courierName][address]) {
                        sameAddressOrders[courierName][address] = [];
                    }
                    sameAddressOrders[courierName][address].push(order.id);
                }
            }
        });
        const courierDeliveriesElement = document.getElementById('courierDeliveries');
        courierDeliveriesElement.innerHTML = '';
        for (const [courierName, deliveries] of Object.entries(courierDeliveries)) {
            const ongoingCount = ongoingDeliveries[courierName] ? ongoingDeliveries[courierName].length : 0;
            let sameAddressInfo = '';
            if (sameAddressOrders[courierName]) {
                for (const [address, orders] of Object.entries(sameAddressOrders[courierName])) {
                    if (orders.length > 1) {
                        sameAddressInfo += `<span class="same-address">${orders.length} mesma casa</span>, `;
                    }
                }
                sameAddressInfo = sameAddressInfo.slice(0, -2); // Remove last comma and space
            }
            courierDeliveriesElement.innerHTML += `
                <div class="courier-deliveries">
                    <span class="courier-name">${courierName}</span>: 
                    <strong>${deliveries}</strong> entrega${deliveries !== 1 ? 's' : ''} finalizadas
                    ${ongoingCount > 0 ? `
                        | <strong>${ongoingCount}</strong> em andamento
                        ${sameAddressInfo ? `(${sameAddressInfo})` : ''}
                        <button class="view-button" onclick="showOngoingDeliveries('${courierName}')">Ver</button>
                    ` : ''}
                </div>
            `;
        }
        saveDataToLocalStorage();
    }

    function showOngoingDeliveries(courierName) {
        const ongoingDeliveries = currentOrders.filter(order =>
            order.courier &&
            order.courier.courierName === courierName &&
            ['accepted', 'ready', 'onGoing', 'dispatched'].includes(order.status)
        );
        let content = `<h3>Pedidos em andamento de <span class="courier-name">${courierName}</span></h3>`;
        if (ongoingDeliveries.length === 0) {
            content += '<p>Nenhum pedido em andamento.</p>';
        } else {
            content += '<ul class="ongoing-orders-list">';
            ongoingDeliveries.forEach(order => {
                content += `
                    <li class="ongoing-order-item">
                        <h4>Pedido #${order.id}</h4>
                        <p>Cliente: ${order.customer.customerName}</p>
                        <p>Endereço: ${order.deliveryPoint.address}</p>
                        <p>Valor: R$ ${order.orderTotal.toFixed(2)}</p>
                        <p>Status: ${getStatusDisplay(order.status)}</p>
                    </li>
                `;
            });
            content += '</ul>';
        }
        const modal = document.getElementById('ongoingModal');
        const modalContent = document.getElementById('ongoingContent');
        modalContent.innerHTML = content;
        modal.style.display = 'block';
    }

    function showReadyOrders() {
        const readyOrders = currentOrders.filter(order => order.status === 'ready');
        let content = `<h3>Pedidos Prontos</h3>`;
        if (readyOrders.length === 0) {
            content += '<p>Nenhum pedido pronto no momento.</p>';
        } else {
            content += '<ul class="ongoing-orders-list">';
            readyOrders.forEach(order => {
                content += `
                    <li class="ongoing-order-item">
                        <h4>Pedido #${order.id}</h4>
                        <p>Cliente: ${order.customer.customerName}</p>
                    </li>
                `;
            });
            content += '</ul>';
        }
        const modal = document.getElementById('readyOrdersModal');
        const modalContent = document.getElementById('readyOrdersContent');
        modalContent.innerHTML = content;
        modal.style.display = 'block';
    }

    function showPriorityOrders() {
        const modal = document.getElementById('priorityOrdersModal');
        const content = document.getElementById('priorityOrdersContent');
        let ordersHtml = '<h3>Pedidos Prioritários</h3>';
        if (priorityOrders.length === 0) {
            ordersHtml += '<p>Nenhum pedido prioritário no momento.</p>';
        } else {
            ordersHtml += '<ul class="ongoing-orders-list">';
            priorityOrders.forEach(order => {
                ordersHtml += `
                    <li class="ongoing-order-item">
                        <h4>Pedido #${order.id}</h4>
                        <p>Cliente: ${order.customer.customerName}</p>
                        <p>Endereço: ${order.deliveryPoint.address}</p>
                        <p>Valor: R$ ${order.orderTotal ? order.orderTotal.toFixed(2) : 'N/A'}</p>
                    </li>
                `;
            });
            ordersHtml += '</ul>';
        }
        content.innerHTML = ordersHtml;
        modal.style.display = 'block';
    }

    function printPriorityOrders() {
        const printWindow = window.open('', '', 'height=400,width=600');
        let printContent = '<html><head><title>Pedidos Prioritários</title></head><body>';
        printContent += '<h3>Pedidos Prioritários</h3>';
        if (priorityOrders.length === 0) {
            printContent += '<p>Nenhum pedido prioritário no momento.</p>';
        } else {
            priorityOrders.forEach(order => {
                printContent += `<p>Pedido #${order.id}</p>`;
                printContent += `<p>Cliente: ${order.customer.customerName}</p>`;
                printContent += `<p>Endereço: ${order.deliveryPoint.address}</p>`;
                printContent += `<p>Valor: R$ ${order.orderTotal ? order.orderTotal.toFixed(2) : 'N/A'}</p>`;
                printContent += '<hr>';
            });
        }
        printContent += '</body></html>';
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
    }

    function checkForCancelledOrders(orders) {
        orders.forEach(order => {
            if (order.status === 'cancelled' && lastOrderStatuses[order.id] !== 'cancelled') {
                showCancellationPopup(order);
            }
            lastOrderStatuses[order.id] = order.status;
        });
    }

    function showCancellationPopup(order) {
        if (hiddenNotifications.cancellation) {
            return;
        }
        const popup = document.getElementById('cancellationPopup');
        const message = document.getElementById('cancellationMessage');
        message.textContent = `O pedido ${order.id} foi cancelado!${order.courier ? ` Motoboy: ${order.courier.courierName}` : ''}`;
        popup.style.display = 'block';
    }

    function closeCancellationPopup() {
        const popup = document.getElementById('cancellationPopup');
        if (popup) {
            popup.style.display = 'none';
        }
    }

    function hideCancellationNotification() {
        hiddenNotifications.cancellation = true;
        closeCancellationPopup();
        saveDataToLocalStorage();
    }

    function checkForSameAddressOrders(orders) {
        const sameAddressMap = {};
        const locationMap = {};
        orders.forEach(order => {
            if (order.status === 'closed' || order.status === 'cancelled') {
                return;
            }
            const address = `${order.deliveryPoint.street} ${order.deliveryPoint.houseNumber}`;
            const location = `${order.deliveryPoint.coordinates.lat},${order.deliveryPoint.coordinates.lng}`;
            if (!sameAddressMap[address]) {
                sameAddressMap[address] = [];
            }
            sameAddressMap[address].push(order);
            if (!locationMap[location]) {
                locationMap[location] = [];
            }
            locationMap[location].push(order);
        });
        let shouldShowNotification = false;
        for (const [address, addressOrders] of Object.entries(sameAddressMap)) {
            if (addressOrders.length > 1) {
                shouldShowNotification = true;
                break;
            }
        }
        if (!shouldShowNotification) {
            for (const [location, locationOrders] of Object.entries(locationMap)) {
                if (locationOrders.length > 1) {
                    shouldShowNotification = true;
                    break;
                }
            }
        }
        if (shouldShowNotification && !hiddenNotifications.sameAddress) {
            showSameAddressPopup(sameAddressMap, locationMap);
        } else {
            closeSameAddressPopup();
        }
    }

    function showSameAddressPopup(sameAddressMap, locationMap) {
        const now = new Date().getTime();
        if (now - lastShownNotificationTime < 120000) { // 2 minutos
            return;
        }
        const popup = document.getElementById('sameAddressPopup');
        const message = document.getElementById('sameAddressMessage');
        let content = '<strong>Pedidos para o mesmo endereço:</strong><br>';
        for (const [address, orders] of Object.entries(sameAddressMap)) {
            if (orders.length > 1) {
                content += `${address}: Pedidos ${orders.map(order => order.id).join(', ')}<br>`;
            }
        }
        for (const [location, orders] of Object.entries(locationMap)) {
            if (orders.length > 1) {
                content += `Localização ${location}: Pedidos ${orders.map(order => order.id).join(', ')}<br>`;
            }
        }
        message.innerHTML = content;
        popup.style.display = 'block';
        lastShownNotificationTime = now;
    }

    function closeSameAddressPopup() {
        const popup = document.getElementById('sameAddressPopup');
        if (popup) {
            popup.style.display = 'none';
        }
    }

    function hideSameAddressNotification() {
        hiddenNotifications.sameAddress = true;
        closeSameAddressPopup();
        saveDataToLocalStorage();
    }

    function resetCounters() {
        totalOrdersCount = 0;
        totalOrdersValue = 0;
        yesterdayOrdersValue = 0;
        paymentMethods = {
            money: 0,
            card: 0,
            online: 0
        };
        totalPrepTime = 0;
        preparedOrders = 0;
        orderPrepTimes = {};
        courierDeliveries = {};
        courierLastRouteTime = {};
        cancelledOrders = 0;
        priorityOrders = [];
        sameAddressOrders = {};
        shownSameAddressNotifications.clear();
        lastShownNotificationTime = 0;
        hiddenNotifications = {
            cancellation: false,
            sameAddress: false
        };
        document.getElementById('avgPrepTime').textContent = '0.0 min';
        document.getElementById('totalOrders').textContent = '0';
        document.getElementById('ongoingOrders').textContent = '0';
        document.getElementById('readyOrders').textContent = '0';
        document.getElementById('cancelledOrders').textContent = '0';
        document.getElementById('priorityOrders').textContent = '0';
        document.getElementById('totalValue').textContent = 'R$ 0.00';
        document.getElementById('yesterdayValue').textContent = 'R$ 0.00';
        document.getElementById('averageTicket').textContent = 'R$ 0.00';
        document.getElementById('paymentBreakdown').innerHTML = '';
        document.getElementById('courierDeliveries').innerHTML = '';
        saveDataToLocalStorage();
    }

    function toggleCreateOrderForm() {
        const form = document.getElementById('createOrderForm');
        const button = document.getElementById('toggleFormButton');
        if (form.style.display === 'none') {
            form.style.display = 'block';
            button.textContent = 'Ocultar Formulário';
        } else {
            form.style.display = 'none';
            button.textContent = 'Criar Novo Pedido';
        }
    }

    async function submitOrder() {
        const order = {
            id: document.getElementById('orderId').value,
            status: document.getElementById('status').value,
            paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
            orderTotal: Number(document.getElementById('orderTotal').value),
            notes: document.getElementById('notes').value,
            orderDetails: document.getElementById('orderDetails').value,
            deliveryPoint: {
                address: `${document.getElementById('street').value}, ${document.getElementById('streetNumber').value}, ${document.getElementById('neighborhood').value}`,
                street: document.getElementById('street').value,
                houseNumber: document.getElementById('streetNumber').value,
                complement: document.getElementById('complement').value,
                postalCode: document.getElementById('zipCode').value,
                city: "Natal",
                region: "RN",
                country: "BR"
            },
            customer: {
                customerPhone: document.getElementById('customerPhone').value,
                customerName: document.getElementById('customerName').value
            }
        };

        try {
            const response = await fetch('https://us-central1-cabana-8d55e.cloudfunctions.net/foodyDeliveryApi/createOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': authToken
                },
                body: JSON.stringify(order)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log('Pedido criado:', result);
            alert('Pedido criado com sucesso!');
            document.getElementById('createOrderForm').reset();
            fetchOrders(); // Atualiza a lista de pedidos
        } catch (error) {
            console.error('Erro ao criar pedido:', error);
            alert('Erro ao criar pedido: ' + error.message);
        }
    }

    function toggleCourierTimeTracking() {
        const trackingDiv = document.getElementById('courierTimeTracking');
        const button = document.getElementById('toggleCourierTimeButton');
        if (trackingDiv.style.display === 'none') {
            trackingDiv.style.display = 'block';
            button.textContent = 'Ocultar Tempo em Rota';
            updateCourierTimeTracking();
        } else {
            trackingDiv.style.display = 'none';
            button.textContent = 'Tempo em Rota dos Motoboys';
        }
    }

function updateCourierTimeTracking() {
    const trackingDiv = document.getElementById('courierTimeTracking');
    let content = '<h3>Tempo em Rota dos Motoboys</h3>';

    for (const courierName in courierActiveOrders) {
        const activeOrders = courierActiveOrders[courierName];
        const onGoingOrders = activeOrders.filter(o => o.status === 'onGoing');
        const startTime = courierTimeTrackingStart[courierName];
        
        let timeInRoute = '00:00:00';

        if (onGoingOrders.length > 0) {
            if (!startTime) {
                // Se há pedidos onGoing mas o tempo não foi iniciado, inicie agora
                courierTimeTrackingStart[courierName] = Date.now();
            }
            const elapsedTime = Math.floor((Date.now() - courierTimeTrackingStart[courierName]) / 1000);
            timeInRoute = new Date(elapsedTime * 1000).toISOString().substr(11, 8);
        } else if (startTime) {
            // Se não há pedidos onGoing mas o tempo estava contando, pare a contagem
            delete courierTimeTrackingStart[courierName];
        }

        content += `
            <div class="courier-time-item">
                <span class="courier-name">${courierName}</span>: 
                <strong>${timeInRoute}</strong>
            </div>
        `;
    }

    trackingDiv.innerHTML = content;
}

function updateCourierStatus(orders) {
    for (const courierName in courierActiveOrders) {
        courierActiveOrders[courierName] = [];
    }

    for (const order of orders) {
        if (order.courier) {
            const courierName = order.courier.courierName;
            if (!courierActiveOrders[courierName]) {
                courierActiveOrders[courierName] = [];
            }
            courierActiveOrders[courierName].push(order);
        }
    }

    for (const courierName in courierActiveOrders) {
        const activeOrders = courierActiveOrders[courierName];
        const allOnGoing = activeOrders.length > 0 && activeOrders.every(o => o.status === 'onGoing');
        const anyOnGoing = activeOrders.some(o => o.status === 'onGoing');

        if (allOnGoing && !courierTimeTrackingStart[courierName]) {
            // Inicia a contagem se todos os pedidos estiverem 'onGoing'
            courierTimeTrackingStart[courierName] = Date.now();
        } else if (!anyOnGoing && courierTimeTrackingStart[courierName]) {
            // Finaliza a contagem se não houver nenhum pedido 'onGoing'
            const elapsedTime = Math.floor((Date.now() - courierTimeTrackingStart[courierName]) / 1000);
            courierLastRouteTime[courierName] = new Date(elapsedTime * 1000).toISOString().substr(11, 8);
            delete courierTimeTrackingStart[courierName];
        }

        if (activeOrders.length === 0) {
            // Se não há pedidos, remove o motoboy das listas ativas
            delete courierActiveOrders[courierName];
            delete courierTimeTrackingStart[courierName];
            delete courierLastRouteTime[courierName];
        }
    }

    updateCourierTimeTracking();
}

    // Inicialização da aplicação
    loadDataFromLocalStorage();
    fetchOrders();
    setInterval(fetchOrders, 10000); // Atualiza a cada 10 segundos
    setInterval(updateCourierTimeTracking, 1000); // Atualiza o tempo em rota a cada segundo

    // Configuração dos modais
    const modals = document.querySelectorAll('.modal');
    const closeSpans = document.querySelectorAll('.close');
    closeSpans.forEach((span) => {
        span.onclick = function() {
            const modal = span.closest('.modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
    });
    window.onclick = function(event) {
        modals.forEach(modal => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
        if (event.target == document.getElementById('cancellationPopup')) {
            closeCancellationPopup();
        }
        if (event.target == document.getElementById('sameAddressPopup')) {
            closeSameAddressPopup();
        }
    }
</script>
</body>
</html>
