<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabana Açaí - Sistema de Entrega</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100%;
        }
        #content {
            display: flex;
            height: 100%;
        }
        #sidebar {
            width: 300px;
            padding: 20px;
            background-color: #f0f0f0;
            overflow-y: auto;
        }
        #map {
            flex-grow: 1;
        }
        .order-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .order-item.selected {
            background-color: #e6f3ff;
        }
        #orderForm {
            display: none;
            margin-top: 20px;
        }
        #orderForm input {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
        }
        #newOrderBtn, #saveOrderBtn, #cancelOrderBtn {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #cancelOrderBtn {
            background-color: #f44336;
        }
        #motoboys {
            margin-top: 20px;
        }
        .motoboy-item {
            margin-bottom: 10px;
            padding: 5px;
            background-color: #e6f3ff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .assign-btn {
            margin-left: 10px;
            padding: 2px 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .status-pending {
            color: orange;
        }
        .status-assigned {
            color: blue;
        }
        .status-delivered {
            color: green;
        }
        #notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            z-index: 1000;
        }
        .notification {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            opacity: 0.9;
            transition: opacity 0.5s;
        }
        .notification.fade-out {
            opacity: 0;
        }
    </style>
</head>
<body>
    <div id="content">
        <div id="sidebar">
            <h2>Pedidos</h2>
            <button id="newOrderBtn">Novo Pedido</button>
            <form id="orderForm">
                <input type="text" id="clientName" placeholder="Nome do Cliente" required>
                <input type="text" id="street" placeholder="Rua" required>
                <input type="text" id="number" placeholder="Número" required>
                <input type="text" id="neighborhood" placeholder="Bairro" required>
                <button type="submit" id="saveOrderBtn">Salvar Pedido</button>
                <button type="button" id="cancelOrderBtn">Cancelar</button>
            </form>
            <div id="orderList"></div>
            <h2>Motoboys</h2>
            <div id="motoboyList"></div>
        </div>
        <div id="map"></div>
    </div>

    <div id="notifications"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Dados de exemplo para os pedidos (agora com status)
        let orders = [
            { id: 1, client: "João", street: "Rua A", number: "123", neighborhood: "Centro", status: "pending" },
            { id: 2, client: "Maria", street: "Av. B", number: "456", neighborhood: "Potengi", status: "pending" },
            { id: 3, client: "Pedro", street: "Praça C", number: "789", neighborhood: "Lagoa Nova", status: "pending" }
        ];

        // Lista de motoboys
        let motoboys = [
            { id: 1, name: "Carlos" },
            { id: 2, name: "Ana" },
            { id: 3, name: "Rafael" }
        ];

        let map;
        let markers = [];
        let selectedOrder = null;

        function initMap() {
            map = L.map('map').setView([-5.7793, -35.2009], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        function updateMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            orders.forEach(order => {
                geocodeAddress(order);
            });
        }

        function geocodeAddress(order) {
            const address = `${order.street}, ${order.number}, ${order.neighborhood}, Natal, RN, Brazil`;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        const marker = L.marker([lat, lon]).addTo(map);
                        marker.bindPopup(`<b>${order.client}</b><br>${address}`);
                        markers.push(marker);
                        if (order === selectedOrder) {
                            map.setView([lat, lon], 15);
                        }
                    }
                });
        }

        function renderOrderList() {
            const orderList = document.getElementById('orderList');
            orderList.innerHTML = '';
            orders.forEach(order => {
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                orderItem.innerHTML = `
                    <strong>Pedido #${order.id}</strong><br>
                    Cliente: ${order.client}<br>
                    Endereço: ${order.street}, ${order.number}, ${order.neighborhood}<br>
                    Status: <span class="status-${order.status}">${getStatusText(order.status)}</span>
                    <button class="editBtn" data-id="${order.id}">Editar</button>
                    ${order.status === 'pending' ? `<button class="assignBtn" data-id="${order.id}">Atribuir</button>` : ''}
                    ${order.status === 'assigned' ? `<button class="deliverBtn" data-id="${order.id}">Marcar como Entregue</button>` : ''}
                `;
                orderItem.addEventListener('click', () => toggleOrderSelection(order));
                orderList.appendChild(orderItem);
            });

            // Adicionar event listeners para os botões
            document.querySelectorAll('.editBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const orderId = parseInt(e.target.getAttribute('data-id'));
                    editOrder(orderId);
                });
            });

            document.querySelectorAll('.assignBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const orderId = parseInt(e.target.getAttribute('data-id'));
                    showMotoboyAssignmentModal(orderId);
                });
            });

            document.querySelectorAll('.deliverBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const orderId = parseInt(e.target.getAttribute('data-id'));
                    markOrderAsDelivered(orderId);
                });
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'Pendente';
                case 'assigned': return 'Atribuído';
                case 'delivered': return 'Entregue';
                default: return 'Desconhecido';
            }
        }

        function toggleOrderSelection(order) {
            if (selectedOrder === order) {
                selectedOrder = null;
            } else {
                selectedOrder = order;
                geocodeAddress(order);
            }
            renderOrderList();
        }

        function showNewOrderForm() {
            document.getElementById('orderForm').style.display = 'block';
            document.getElementById('newOrderBtn').style.display = 'none';
        }

        function hideNewOrderForm() {
            document.getElementById('orderForm').style.display = 'none';
            document.getElementById('newOrderBtn').style.display = 'block';
            document.getElementById('orderForm').reset();
        }

        function saveOrder(event) {
            event.preventDefault();
            const clientName = document.getElementById('clientName').value;
            const street = document.getElementById('street').value;
            const number = document.getElementById('number').value;
            const neighborhood = document.getElementById('neighborhood').value;
            const newOrder = {
                id: orders.length + 1,
                client: clientName,
                street: street,
                number: number,
                neighborhood: neighborhood,
                status: 'pending'
            };
            orders.push(newOrder);
            renderOrderList();
            updateMap();
            hideNewOrderForm();
            showNotification(`Novo pedido criado para ${clientName}`);
        }

        function editOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                document.getElementById('clientName').value = order.client;
                document.getElementById('street').value = order.street;
                document.getElementById('number').value = order.number;
                document.getElementById('neighborhood').value = order.neighborhood;
                showNewOrderForm();
                // Remove o pedido existente e adiciona o atualizado ao salvar
                orders = orders.filter(o => o.id !== orderId);
            }
        }

        function showMotoboyAssignmentModal(orderId) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.left = '50%';
            modal.style.top = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
            modal.style.backgroundColor = 'white';
            modal.style.padding = '20px';
            modal.style.border = '1px solid black';
            modal.style.zIndex = '1000';

            modal.innerHTML = `
                <h3>Atribuir Pedido #${orderId} a um Motoboy</h3>
                <select id="motoboySelect">
                    ${motoboys.map(motoboy => `<option value="${motoboy.id}">${motoboy.name}</option>`).join('')}
                </select>
                <button id="confirmAssign">Confirmar</button>
                <button id="cancelAssign">Cancelar</button>
            `;

            document.body.appendChild(modal);

            document.getElementById('confirmAssign').addEventListener('click', () => {
                const motoboyId = document.getElementById('motoboySelect').value;
                assignOrderToMotoboy(orderId, parseInt(motoboyId));
                document.body.removeChild(modal);
            });

            document.getElementById('cancelAssign').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        function assignOrderToMotoboy(orderId, motoboyId) {
            const order = orders.find(o => o.id === orderId);
            const motoboy = motoboys.find(m => m.id === motoboyId);
            if (order && motoboy) {
                order.status = 'assigned';
                order.motoboyId = motoboyId;
                renderOrderList();
                updateMap();
                showNotification(`Pedido #${orderId} atribuído a ${motoboy.name}`);
            }
        }

        function markOrderAsDelivered(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'delivered';
                renderOrderList();
                updateMap();
                showNotification(`Pedido #${orderId} entregue com sucesso`);
            }
        }

        function renderMotoboyList() {
            const motoboyList = document.getElementById('motoboyList');
            motoboyList.innerHTML = '';
            motoboys.forEach(motoboy => {
                const motoboyItem = document.createElement('div');
                motoboyItem.className = 'motoboy-item';
                motoboyItem.innerHTML = `
                    <strong>${motoboy.name}</strong>
                    <button class="viewOrdersBtn" data-id="${motoboy.id}">Ver Pedidos</button>
                `;
                motoboyList.appendChild(motoboyItem);
            });

            document.querySelectorAll('.viewOrdersBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const motoboyId = parseInt(e.target.getAttribute('data-id'));
                    showMotoboyOrders(motoboyId);
                });
            });
        }

        function showMotoboyOrders(motoboyId) {
            const motoboyOrders = orders.filter(order => order.motoboyId === motoboyId && order.status === 'assigned');
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.left = '50%';
            modal.style.top = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
            modal.style.backgroundColor = 'white';
            modal.style.padding = '20px';
            modal.style.border = '1px solid black';
            modal.style.zIndex = '1000';

            modal.innerHTML = `
                <h3>Pedidos do Motoboy ${motoboys.find(m => m.id === motoboyId).name}</h3>
                <ul>
                    ${motoboyOrders.map(order => `
                        <li>
                            Pedido #${order.id}: ${order.client} - ${order.street}, ${order.number}, ${order.neighborhood}
                        </li>
                    `).join('')}
                </ul>
                <button id="closeModal">Fechar</button>
            `;

            document.body.appendChild(modal);

            document.getElementById('closeModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        function showNotification(message) {
            const notifications = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.text
