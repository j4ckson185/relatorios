<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Pedidos - Foody Delivery</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        /* ... (estilos permanecem os mesmos) ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Pedidos</h2>
            <div class="filter-section">
                <div id="orderList" class="order-list"></div>
            </div>
        </div>
        <div class="main-content">
            <div id="map"></div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E",
            authDomain: "cabana-8d55e.firebaseapp.com",
            databaseURL: "https://cabana-8d55e-default-rtdb.firebaseio.com",
            projectId: "cabana-8d55e",
            storageBucket: "cabana-8d55e.appspot.com",
            messagingSenderId: "706144237954",
            appId: "1:706144237954:web:345c10370972486afc779b",
            measurementId: "G-96Y337GYT8"
        };
        firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();
        let map;
        let markers = {};
        const firebaseFunctionUrl = 'https://us-central1-cabana-8d55e.cloudfunctions.net/getFoodyOrders/proxy';
        const trackingUrl = 'https://us-central1-cabana-8d55e.cloudfunctions.net/getFoodyTracking/tracking';
        const authToken = '8d7c77946d534444a168bb7da794febf';
        const foodyApiUrl = 'https://app.foodydelivery.com/rest/1.2/orders/';

        function initMap() {
            const centerAddress = { lat: -5.750636, lng: -35.254625 };
            map = new google.maps.Map(document.getElementById('map'), {
                center: centerAddress,
                zoom: 16
            });

            new google.maps.Marker({
                position: centerAddress,
                map: map,
                title: "Rua Serra do Mar, 1216, Potengi",
                icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            });
        }

        function formatDate(date) {
            return date.toISOString().replace(/\.\d{3}Z$/, '-03:00');
        }

        async function fetchOrders() {
            try {
                const now = new Date();
                const startDate = formatDate(new Date(now.getTime() - 24 * 60 * 60 * 1000));
                const endDate = formatDate(now);
                
                console.log('Buscando pedidos da API Foody...');
                const response = await axios.get(firebaseFunctionUrl, {
                    headers: {
                        'Authorization': authToken,
                        'Content-Type': 'application/json;charset=UTF-8'
                    },
                    params: {
                        url: `${foodyApiUrl}?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`
                    }
                });
                console.log('Resposta da API Foody:', response.data);
                
                const filteredOrders = response.data.filter(order => 
                    ['onGoing', 'ready', 'dispatched', 'accepted'].includes(order.status)
                );
                console.log('Pedidos filtrados:', filteredOrders);

                updateOrderList(filteredOrders);
                updateMap(filteredOrders);
                saveOrdersToFirestore(filteredOrders);
            } catch (error) {
                console.error('Erro ao buscar pedidos:', error);
                document.getElementById('orderList').innerHTML = '<p class="error">Erro ao carregar pedidos. Por favor, tente novamente mais tarde.</p>';
            }
        }

        // ... (outras funções permanecem as mesmas) ...

        function saveOrdersToFirestore(orders) {
            console.log('Iniciando salvamento de pedidos no Firestore...');
            orders.forEach(order => {
                console.log('Tentando salvar pedido:', order.id);
                db.collection('foodyOrders').doc(order.id.toString()).set(order)
                    .then(() => {
                        console.log('Pedido salvo com sucesso no Firestore:', order.id);
                    })
                    .catch(error => {
                        console.error('Erro ao salvar pedido:', order.id, error);
                    });
            });
        }

        initMap();
        fetchOrders();
        setInterval(fetchOrders, 10000); // Atualiza a cada 10 segundos
    </script>
</body>
</html>
