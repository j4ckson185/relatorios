<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabana Açaí - Sistema de Entrega</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }
        #header {
            background-color: #ff6b6b;
            color: white;
            padding: 10px;
            text-align: center;
        }
        #content {
            display: flex;
            flex: 1;
        }
        #sidebar {
            width: 300px;
            padding: 10px;
            background-color: #f0f0f0;
            overflow-y: auto;
        }
        #map {
            flex: 1;
        }
        .order-item {
            margin-bottom: 10px;
            padding: 5px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .order-item.selected {
            background-color: #e6f3ff;
        }
        #newOrderBtn, .editBtn {
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #orderForm {
            display: none;
            background-color: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        #orderForm input, #orderForm button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
        }
        #orderForm button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .error {
            color: red;
            font-size: 0.8em;
            margin-top: -5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Cabana Açaí</h1>
    </div>
    <div id="content">
        <div id="sidebar">
            <h2>Pedidos</h2>
            <button id="newOrderBtn">Novo Pedido</button>
            <form id="orderForm">
                <input type="hidden" id="orderId">
                <input type="text" id="clientName" placeholder="Nome do Cliente" required minlength="3" maxlength="50">
                <div id="clientNameError" class="error"></div>
                <input type="text" id="street" placeholder="Rua" required minlength="3" maxlength="100">
                <div id="streetError" class="error"></div>
                <input type="text" id="number" placeholder="Número" required pattern="[0-9]+">
                <div id="numberError" class="error"></div>
                <input type="text" id="neighborhood" placeholder="Bairro" required minlength="2" maxlength="50">
                <div id="neighborhoodError" class="error"></div>
                <button type="submit">Salvar Pedido</button>
            </form>
            <div id="orderList"></div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Dados de exemplo para os pedidos
        let orders = [
            { id: 1, client: "João", street: "Rua A", number: "123", neighborhood: "Centro" },
            { id: 2, client: "Maria", street: "Av. B", number: "456", neighborhood: "Potengi" },
            { id: 3, client: "Pedro", street: "Praça C", number: "789", neighborhood: "Lagoa Nova" }
        ];

        // Inicialização do mapa
        const map = L.map('map').setView([-5.7373, -35.2452], 13); // Coordenadas aproximadas de Natal, RN
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let markers = {};

        // Função para renderizar a lista de pedidos
        function renderOrderList() {
            const orderList = document.getElementById('orderList');
            orderList.innerHTML = '';
            orders.forEach(order => {
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                orderItem.innerHTML = `
                    <strong>Pedido #${order.id}</strong><br>
                    Cliente: ${order.client}<br>
                    Endereço: ${order.street}, ${order.number}, ${order.neighborhood}
                    <button class="editBtn" data-id="${order.id}">Editar</button>
                `;
                orderItem.addEventListener('click', () => toggleOrderSelection(order));
                orderList.appendChild(orderItem);
            });

            // Adicionar event listeners para os botões de edição
            document.querySelectorAll('.editBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Previne a propagação do evento para o item do pedido
                    const orderId = parseInt(e.target.getAttribute('data-id'));
                    editOrder(orderId);
                });
            });
        }

        // Função para alternar a seleção de um pedido
        function toggleOrderSelection(order) {
            const orderItem = document.querySelector(`.order-item:nth-child(${order.id})`);
            orderItem.classList.toggle('selected');
            updateMap();
        }

        // Função para atualizar o mapa com base nos pedidos selecionados
        function updateMap() {
            // Limpar todos os marcadores existentes
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};

            // Adicionar marcadores para pedidos selecionados
            const selectedOrders = document.querySelectorAll('.order-item.selected');
            const ordersToShow = selectedOrders.length > 0 ? 
                Array.from(selectedOrders).map(el => orders.find(o => o.id === parseInt(el.querySelector('.editBtn').getAttribute('data-id')))) : 
                orders;

            ordersToShow.forEach(order => {
                geocodeAddress(order);
            });
        }

        // Função para geocodificar o endereço
        function geocodeAddress(order) {
            const address = `${order.street}, ${order.number}, ${order.neighborhood}, Natal, RN, Brazil`;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        const marker = L.marker([lat, lon]).addTo(map);
                        marker.bindPopup(`Pedido #${order.id}<br>${order.client}<br>${address}`);
                        markers[order.id] = marker;
                    }
                })
                .catch(error => console.error('Erro na geocodificação:', error));
        }

        // Função para editar um pedido existente
        function editOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                document.getElementById('orderId').value = order.id;
                document.getElementById('clientName').value = order.client;
                document.getElementById('street').value = order.street;
                document.getElementById('number').value = order.number;
                document.getElementById('neighborhood').value = order.neighborhood;
                orderForm.style.display = 'block';
            }
        }

        // Função de validação personalizada
        function validateForm() {
            let isValid = true;
            const fields = [
                { id: 'clientName', errorId: 'clientNameError', errorMsg: 'Nome deve ter entre 3 e 50 caracteres.' },
                { id: 'street', errorId: 'streetError', errorMsg: 'Rua deve ter entre 3 e 100 caracteres.' },
                { id: 'number', errorId: 'numberError', errorMsg: 'Número deve conter apenas dígitos.' },
                { id: 'neighborhood', errorId: 'neighborhoodError', errorMsg: 'Bairro deve ter entre 2 e 50 caracteres.' }
            ];

            fields.forEach(field => {
                const input = document.getElementById(field.id);
                const errorElement = document.getElementById(field.errorId);
                errorElement.textContent = '';

                if (!input.checkValidity()) {
                    errorElement.textContent = field.errorMsg;
                    isValid = false;
                }
            });

            return isValid;
        }

        // Manipulação do formulário de pedido
        const newOrderBtn = document.getElementById('newOrderBtn');
        const orderForm = document.getElementById('orderForm');

        newOrderBtn.addEventListener('click', () => {
            orderForm.reset();
            document.getElementById('orderId').value = '';
            orderForm.style.display = 'block';
            // Limpar mensagens de erro
            document.querySelectorAll('.error').forEach(el => el.textContent = '');
        });

        orderForm.addEventListener('submit', (e) => {
            e.preventDefault();

            if (!validateForm()) {
                return; // Parar a submissão se a validação falhar
            }

            const orderId = document.getElementById('orderId').value;
            const clientName = document.getElementById('clientName').value;
            const street = document.getElementById('street').value;
            const number = document.getElementById('number').value;
            const neighborhood = document.getElementById('neighborhood').value;

            if (orderId) {
                // Editar pedido existente
                const orderIndex = orders.findIndex(o => o.id === parseInt(orderId));
                if (orderIndex !== -1) {
                    orders[orderIndex] = { id: parseInt(orderId), client: clientName, street, number, neighborhood };
                }
            } else {
                // Adicionar novo pedido
                const newOrder = {
                    id: orders.length + 1,
                    client: clientName,
                    street,
                    number,
                    neighborhood
                };
                orders.push(newOrder);
            }

            renderOrderList();
            updateMap();
            orderForm.reset();
            orderForm.style.display = 'none';
        });

        // Inicializar a lista de pedidos e o mapa
        renderOrderList();
        updateMap();

        // Centralizar o mapa na Rua Serra do Mar, 1216, Potengi
        geocodeAddress({ street: "Rua Serra do Mar", number: "1216", neighborhood: "Potengi" });
    </script>
</body>
</html>
